<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://bytecodealliance.github.io/wamr.dev/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://bytecodealliance.github.io/wamr.dev/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://bytecodealliance.github.io/wamr.dev/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://bytecodealliance.github.io/wamr.dev/main.38cbab29a241a8ffa150452901bb274d4784732af0ecca917750a4b84906a34ddc38e2ed328382ca6f8d21261ddd21427b29ead40063b710689c39cec8663b0d.css integrity="sha512-OMurKaJBqP+hUEUpAbsnTUeEcyrw7MqRd1CkuEkGo03cOOLtMoOCym+NISYd3SFCeynq1ABjtxBonDnOyGY7DQ==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Architecture for transferring data between host and wasm app - WAMR</title><meta name=description content="Architecture for transferring data between Host and WASM app # To facilitate handling various situations of data transmission, we need to design an overall architecture to handle data transmission situations. Of course, you don&amp;rsquo;t necessarily need this architecture, it&amp;rsquo;s just a reference.
This architecture is divided into 5 layers: the native layer, the native wrapper layer, the wasm wrapper layer, and the wasm layer, the mapping layer.
The native layer, the native wrapper layer and the mapping layer are all running in the native context, while the wasm layer and the wasm wrapper layer are both running in the wasm context."><link rel=canonical href=https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Architecture for transferring data between host and wasm app"><meta property="og:description" content="Architecture for transferring data between Host and WASM app # To facilitate handling various situations of data transmission, we need to design an overall architecture to handle data transmission situations. Of course, you don&rsquo;t necessarily need this architecture, it&rsquo;s just a reference.
This architecture is divided into 5 layers: the native layer, the native wrapper layer, the wasm wrapper layer, and the wasm layer, the mapping layer.
The native layer, the native wrapper layer and the mapping layer are all running in the native context, while the wasm layer and the wasm wrapper layer are both running in the wasm context."><meta property="og:url" content="https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/"><meta property="og:site_name" content="WAMR"><meta property="article:published_time" content="2023-04-03T21:03:20+08:00"><meta property="article:modified_time" content="2023-04-03T21:03:20+08:00"><meta property="og:image" content="https://bytecodealliance.github.io/wamr.dev/wamr.png"><meta property="og:image:alt" content="WAMR"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="Architecture for transferring data between host and wasm app"><meta name=twitter:description content><meta name=twitter:image content="https://bytecodealliance.github.io/wamr.dev/wamr.png"><meta name=twitter:image:alt content="Architecture for transferring data between host and wasm app"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://bytecodealliance.github.io/#/schema/organization/1","name":"WAMR","url":"https://bytecodealliance.github.io/","sameAs":["https://github.com/bytecodealliance/wamr.dev"],"logo":{"@type":"ImageObject","@id":"https://bytecodealliance.github.io/#/schema/image/1","url":"https://bytecodealliance.github.io/logo-doks.png","width":512,"height":512,"caption":"WAMR"},"image":{"@id":"https://bytecodealliance.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://bytecodealliance.github.io/#/schema/website/1","url":"https://bytecodealliance.github.io/","name":"WAMR","description":"WebAssembly Micro Runtime (WAMR) is a lightweight standalone WebAssembly (WASM) runtime with small footprint, high performance and highly configurable features for applications cross from embedded, IoT, edge to Trusted Execution Environment (TEE), smart contract, cloud native and so on.","publisher":{"@id":"https://bytecodealliance.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/","url":"https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/","name":"Architecture for transferring data between host and wasm app","description":"","isPartOf":{"@id":"https://bytecodealliance.github.io/#/schema/website/1"},"about":{"@id":"https://bytecodealliance.github.io/#/schema/organization/1"},"datePublished":"2023-04-03T21:03:20CET","dateModified":"2023-04-03T21:03:20CET","breadcrumb":{"@id":"https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/"]}]},{"@type":"BreadcrumbList","@id":"https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://bytecodealliance.github.io/wamr.dev/","url":"https://bytecodealliance.github.io/wamr.dev/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://bytecodealliance.github.io/wamr.dev/blog/","url":"https://bytecodealliance.github.io/wamr.dev/blog/","name":"Blog"}},{"@type":"ListItem","position":3,"item":{"@id":"https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://bytecodealliance.github.io/#/schema/article/1","headline":"Architecture for transferring data between host and wasm app","description":"","isPartOf":{"@id":"https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/"},"mainEntityOfPage":{"@id":"https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/"},"datePublished":"2023-04-03T21:03:20CET","dateModified":"2023-04-03T21:03:20CET","author":{"@id":"https://bytecodealliance.github.io/#/schema/person/2"},"publisher":{"@id":"https://bytecodealliance.github.io/#/schema/organization/1"},"image":{"@id":"https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://bytecodealliance.github.io/#/schema/person/2","name":null,"sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://bytecodealliance.github.io/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/#/schema/image/2","url":"https://bytecodealliance.github.io/wamr.dev/wamr.png","contentUrl":"https://bytecodealliance.github.io/wamr.dev/wamr.png","caption":"Architecture for transferring data between host and wasm app"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=https://bytecodealliance.github.io/wamr.dev/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=https://bytecodealliance.github.io/wamr.dev/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=https://bytecodealliance.github.io/wamr.dev/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://bytecodealliance.github.io/wamr.dev/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://bytecodealliance.github.io/wamr.dev/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://bytecodealliance.github.io/wamr.dev/site.webmanifest></head><body class="blog single"><div class=sticky-top><style>.brand{position:relative;float:left;left:10px;z-index:1;padding:16px 0;text-decoration:none;color:#333}.brand:hover{filter:brightness(60%)}</style><div class=header-bar></div><header class="navbar navbar-expand-lg navbar-light doks-navbar"><div><a href=https://bytecodealliance.org/ class=brand><img src=https://bytecodealliance.github.io/wamr.dev//bytecode-alliance-logo.svg alt="Bytecode Alliance logo" width=164></a></div><nav class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=https://bytecodealliance.github.io/wamr.dev/ aria-label=WAMR>WAMR</a>
<button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>WAMR</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class=nav-item><a class="nav-link ps-0 py-1 active" href=/wamr.dev/blog/>Blog</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/wamr.dev/events/>Events</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/wamr.dev/resources/>Resources</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/bytecodealliance/wasm-micro-runtime><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul><hr class="text-black-50 my-4 d-lg-none"><button id=mode class="btn btn-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></div></div></nav></header></div><div class="wrap container-xxl" role=document><div class=content><article><div class="row justify-content-center"><div class="col-md-12 col-lg-10"><div class=blog-header><h1>Architecture for transferring data between host and wasm app</h1><p><small>Posted&nbsp;in&nbsp;<a class="stretched-link position-relative link-muted" href=https://bytecodealliance.github.io/wamr.dev/categories/transferring-data/>transferring data</a>&nbsp;on&nbsp;April 3, 2023 by <a class="stretched-link position-relative" href=https://bytecodealliance.github.io/wamr.dev/contributors/jiongqiang-li/>Jiongqiang Li</a>&nbsp;&dash;&nbsp;<strong>3&nbsp;min read</strong></small><p></div></div><div class=col-md-13><div></div></div><div class="col-md-12 col-lg-12"><h3 id=architecture-for-transferring-data-between-host-and-wasm-app>Architecture for transferring data between Host and WASM app <a href=#architecture-for-transferring-data-between-host-and-wasm-app class=anchor aria-hidden=true>#</a></h3><p>To facilitate handling various situations of data transmission, we need to design an overall architecture to handle data transmission situations. Of course, you don&rsquo;t necessarily need this architecture, it&rsquo;s just a reference.</p><p>This architecture is divided into 5 layers: <code>the native layer</code>, <code>the native wrapper layer</code>, <code>the wasm wrapper layer</code>, and <code>the wasm layer</code>, <code>the mapping layer</code>.</p><p><img class="img-fluid lazyload blur-up" src=/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/images/architecture.svg></p><p><code>The native layer</code>, <code>the native wrapper layer</code> and <code>the mapping layer</code> are all running in <code>the native context</code>, <code>while the wasm layer</code> and <code>the wasm wrapper layer</code> are both running in <code>the wasm context</code>.</p><h4 id=1-native-layer-and-the-native-wrapper-layer>1. native layer and the native wrapper layer <a href=#1-native-layer-and-the-native-wrapper-layer class=anchor aria-hidden=true>#</a></h4><p><code>The native layer</code> is composed of native functions, and implement the function of the native API.</p><p>In <code>the native wrapper layer</code> is composed of native functions too, But implement the function of data conversion between two worlds. We can process parameters and try to solve data transmission problems in this layer.</p><p>It is worth noting that during <code>native call wasm</code>, it is not necessary to pass through <code>the native wrapper layer</code>.</p><p>Here is an <code>wasm cal native</code> example to show <code>the native wrapper layer</code> and <code>the native layer</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//structure
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>enum</span> <span class=nc>OP</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>SUM</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>COUNT_ZERO</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Data</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>enum</span> <span class=nc>OP</span> <span class=n>op_type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=o>*</span><span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=c1>//the native wrapper later
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>native_function_wrapper</span><span class=p>(</span><span class=n>wasm_exec_env_t</span> <span class=n>exec_env</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>Data</span> <span class=o>*</span><span class=n>wasm_data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>wasm_module_inst_t</span> <span class=n>wasm_module_inst</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>Data</span> <span class=n>tmp</span> <span class=o>=</span> <span class=o>*</span><span class=n>wasm_data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ans</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>exec_env</span> <span class=o>||</span> <span class=o>!</span><span class=p>(</span><span class=n>wasm_module_inst</span> <span class=o>=</span> <span class=n>wasm_runtime_get_module_inst</span><span class=p>(</span><span class=n>exec_env</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>assert</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// we need to convert this wasm offset to a native pointer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>tmp</span><span class=p>.</span><span class=n>data</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=p>)</span><span class=n>wasm_runtime_addr_app_to_native</span><span class=p>(</span><span class=n>wasm_module_inst</span><span class=p>,</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=n>wasm_data</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span><span class=p>(</span><span class=n>wasm_data</span><span class=o>-&gt;</span><span class=n>op_type</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>SUM</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>=</span> <span class=n>sum</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tmp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>COUNT_ZERO</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>=</span> <span class=n>count_zero</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tmp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>assert</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ans</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>//the native layer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>sum</span><span class=p>(</span><span class=k>struct</span> <span class=nc>Data</span> <span class=o>*</span><span class=n>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>data</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ans</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=n>size</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>+=</span> <span class=n>data</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>[</span><span class=n>size</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ans</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>count_zero</span><span class=p>(</span><span class=k>struct</span> <span class=nc>Data</span> <span class=o>*</span><span class=n>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>data</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ans</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=n>size</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>+=</span> <span class=p>(</span><span class=mi>0</span> <span class=o>==</span> <span class=n>data</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>[</span><span class=n>size</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ans</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=2-wasm-layer-and-the-wasm-wrapper-layer>2. wasm layer and the wasm wrapper layer <a href=#2-wasm-layer-and-the-wasm-wrapper-layer class=anchor aria-hidden=true>#</a></h4><p><code>The WASM layer</code> is composed of wasm functions, and implement the main function of wasm app.</p><p>In <code>the wasm wrapper layer</code> is composed of wasm functions too, But implement the function of data conversion between two worlds. We can process parameters and try to solve data transmission problems in this layer.</p><p>It is worth noting that during <code>wasm call native</code> or <code>native call wasm</code>, it is not necessary to pass through <code>the wasm wrapper layer</code></p><p>Here is an <code>wasm call native</code> example to show <code>the wasm wrapper layer</code> and <code>the wasm layer</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//the wasm wrapper later
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>sum</span><span class=p>(</span><span class=kt>int</span> <span class=n>data</span><span class=p>[],</span> <span class=kt>int</span> <span class=n>size</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>Data</span> <span class=n>tmp</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>SUM</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;</span><span class=n>data</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// call naive api
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>native_function_wrapper</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tmp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>//the wasm layer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>data</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>sum</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=o>/</span><span class=k>sizeof</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>])));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=3-mapping-layer>3. mapping layer <a href=#3-mapping-layer class=anchor aria-hidden=true>#</a></h4><p><img class="img-fluid lazyload blur-up" src=/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/images/mapping.svg></p><p><code>The mapping layer</code> is running in <code>the native context</code>.</p><p>Sometimes there may be unique data in the native world, and wasm apps cannot directly access this data due to sandbox isolation. At this point, we may need <code>a mapping layer</code> that can solve some of the problems. This mapping layer is useful for mapping some constant data.
This layer will map some unique data in <code>native world</code> to a copy in <code>wasm world</code> or a handle, such as mapping a string &ldquo;Intel&rdquo; in <code>the native world</code> to a copied string &ldquo;Intel&rdquo; in <code>the wasm world</code>, or a handle with a value of 32 (in this case, in <code>the wasm context</code>, this handle represents the string &ldquo;Intel&rdquo;).</p><p><img class="img-fluid lazyload blur-up" src=/wamr.dev/blog/architecture-for-transferring-data-between-host-and-wasm-app/images/mappingArchitecture.svg></p><p>It is worth noting that during <code>wasm call native</code> or <code>native call wasm</code>, it is not necessary to pass through <code>the mapping layer</code></p><div class=card><div class=card-header>Interested in WAMR?</div><div class=card-body><div class=row><a style=margin-top:10px href=https://bytecodealliance.zulipchat.com/#narrow/stream/290350-wamr><img src=https://img.shields.io/badge/zulip-join_chat-brightgreen.svg></a>
<a style=margin-top:10px href=https://github.com/bytecodealliance/wasm-micro-runtime><img alt="GitHub Repo stars" src="https://img.shields.io/github/stars/bytecodealliance/wasm-micro-runtime?label=WAMR%C2%B7Stars&style=social"></a>
<a style=margin-top:10px href=https://github.com/bytecodealliance/wasm-micro-runtime/fork><img alt="GitHub forks" src="https://img.shields.io/github/forks/bytecodealliance/wasm-micro-runtime?label=WAMR%C2%B7Forks&style=social"></a></div></div></div></div></div></article><div class=related-posts><div class="row justify-content-center"><div class=col><h2 class=section-title>Related posts</h2></div></div><div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-lg-5"><div class=col><div class=card><img class="card-img-top img-fluid lazyload blur-up" src=https://bytecodealliance.github.io/wamr.dev/images/webassembly-pic_hufbeecd7296df170cb8eea885384f41c3_20814_6d8a2b6aa74b933b123f4287214ddce8.webp data-src=https://bytecodealliance.github.io/wamr.dev/images/webassembly-pic_hufbeecd7296df170cb8eea885384f41c3_20814_1270x620_resize_q75_h2_box_3.webp width=1270 height=620 alt="Transferring data from host to wasm apps"><div class=card-body><article><h2 class=h3><a class="stretched-link text-body" href=/wamr.dev/blog/transferring-data-from-host-to-wasm-apps/>Transferring data from host to wasm apps</a></h2><p></p><p><small>Posted&nbsp;in&nbsp;<a class="stretched-link position-relative link-muted" href=https://bytecodealliance.github.io/wamr.dev/categories/transferring-data/>transferring data</a>&nbsp;on&nbsp;April 4, 2023 by <a class="stretched-link position-relative" href=https://bytecodealliance.github.io/wamr.dev/contributors/jiongqiang-li/>Jiongqiang Li</a>&nbsp;&dash;&nbsp;<strong>6&nbsp;min read</strong></small><p></article></div></div></div><div class=col><div class=card><img class="card-img-top img-fluid lazyload blur-up" src=https://bytecodealliance.github.io/wamr.dev/images/webassembly-pic_hufbeecd7296df170cb8eea885384f41c3_20814_6d8a2b6aa74b933b123f4287214ddce8.webp data-src=https://bytecodealliance.github.io/wamr.dev/images/webassembly-pic_hufbeecd7296df170cb8eea885384f41c3_20814_1270x620_resize_q75_h2_box_3.webp width=1270 height=620 alt="Overview of transfering data between Host and WASM app"><div class=card-body><article><h2 class=h3><a class="stretched-link text-body" href=/wamr.dev/blog/overview-of-transfering-data-between-host-and-wasm-app/>Overview of transfering data between Host and WASM app</a></h2><p></p><p><small>Posted&nbsp;in&nbsp;<a class="stretched-link position-relative link-muted" href=https://bytecodealliance.github.io/wamr.dev/categories/transferring-data/>transferring data</a>&nbsp;on&nbsp;April 3, 2023 by <a class="stretched-link position-relative" href=https://bytecodealliance.github.io/wamr.dev/contributors/jiongqiang-li/>Jiongqiang Li</a>&nbsp;&dash;&nbsp;<strong>3&nbsp;min read</strong></small><p></article></div></div></div></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://gohugo.io/>Hugo</a>, and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=/wamr.dev/js/bootstrap.min.650aeec64c81d69d4c0850fc73c93da3f0330cec0a27772feed7f90f60baa5f47f1c45687d71914bdafd1c4e860d40f6dc08ede27a2f08431ff929c9a2d24621.js integrity="sha512-ZQruxkyB1p1MCFD8c8k9o/AzDOwKJ3cv7tf5D2C6pfR/HEVofXGRS9r9HE6GDUD23Ajt4novCEMf+SnJotJGIQ==" crossorigin=anonymous defer></script>
<script src=/wamr.dev/js/highlight.min.6efdec8375dd620e0a357860aafeb5c97c7b51f33c9c594d57fa7f76cf22d2a6e0e39f8127dfed74d737512bfdb23f641827578b3fe09da15442a003c878a033.js integrity="sha512-bv3sg3XdYg4KNXhgqv61yXx7UfM8nFlNV/p/ds8i0qbg45+BJ9/tdNc3USv9sj9kGCdXiz/gnaFUQqADyHigMw==" crossorigin=anonymous defer></script>
<script src=/wamr.dev/main.min.cb2e2ebbf2e4002f3117addc33582923b2b3ae5265c22944cd117ebec7abe61c170417c4506d7a0f8f0fc9053dfdf441421d53601ac467042ff3d06ec0ba07fa.js integrity="sha512-yy4uu/LkAC8xF63cM1gpI7KzrlJlwilEzRF+vser5hwXBBfEUG16D48PyQU9/fRBQh1TYBrEZwQv89BuwLoH+g==" crossorigin=anonymous defer></script>
<script src=https://bytecodealliance.github.io/wamr.dev/index.min.4ae26272486ea46c5bb0bed7a0b434a91b05e8182cfb839a405dd4e647b05ce5d76d401a5103d822d3b1589fc56335cd372b712d97085b8d89aebf244b1b5501.js integrity="sha512-SuJickhupGxbsL7XoLQ0qRsF6Bgs+4OaQF3U5kewXOXXbUAaUQPYItOxWJ/FYzXNNytxLZcIW42Jrr8kSxtVAQ==" crossorigin=anonymous defer></script></body></html>