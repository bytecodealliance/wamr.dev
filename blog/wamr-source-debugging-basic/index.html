<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://bytecodealliance.github.io/wamr.dev/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://bytecodealliance.github.io/wamr.dev/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://bytecodealliance.github.io/wamr.dev/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://bytecodealliance.github.io/wamr.dev/main.b007b705bbba515c59a68c0f81c875a0aab2ba9a15517642044b21c9975c26b539f0cf292378d1d1aff68b935d7a6aaf0ab8b9de65219fe5d2e93674cbd309c3.css integrity="sha512-sAe3Bbu6UVxZpowPgch1oKqyupoVUXZCBEshyZdcJrU58M8pI3jR0a/2i5NdemqvCri53mUhn+XS6TZ0y9MJww==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>WAMR source debugging basic - WAMR</title><meta name=description content="WAMR source debugging basic"><link rel=canonical href=https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="WAMR source debugging basic"><meta property="og:description" content="WAMR source debugging basic"><meta property="og:url" content="https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/"><meta property="og:site_name" content="WAMR"><meta property="article:published_time" content="2022-10-15T14:23:03+08:00"><meta property="article:modified_time" content="2022-10-15T14:23:03+08:00"><meta property="og:image" content="https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="WAMR source debugging basic"><meta name=twitter:description content="WAMR source debugging basic"><meta name=twitter:image content="https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover.png"><meta name=twitter:image:alt content="WAMR source debugging basic"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://bytecodealliance.github.io/#/schema/organization/1","name":"WAMR","url":"https://bytecodealliance.github.io/","sameAs":["https://github.com/bytecodealliance/wamr.dev"],"logo":{"@type":"ImageObject","@id":"https://bytecodealliance.github.io/#/schema/image/1","url":"https://bytecodealliance.github.io/logo-doks.png","width":512,"height":512,"caption":"WAMR"},"image":{"@id":"https://bytecodealliance.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://bytecodealliance.github.io/#/schema/website/1","url":"https://bytecodealliance.github.io/","name":"WAMR","description":"WebAssembly Micro Runtime (WAMR) is a lightweight standalone WebAssembly (WASM) runtime with small footprint, high performance and highly configurable features for applications cross from embedded, IoT, edge to Trusted Execution Environment (TEE), smart contract, cloud native and so on.","publisher":{"@id":"https://bytecodealliance.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/","url":"https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/","name":"WAMR source debugging basic","description":"WAMR source debugging basic","isPartOf":{"@id":"https://bytecodealliance.github.io/#/schema/website/1"},"about":{"@id":"https://bytecodealliance.github.io/#/schema/organization/1"},"datePublished":"2022-10-15T14:23:03CET","dateModified":"2022-10-15T14:23:03CET","breadcrumb":{"@id":"https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/"]}]},{"@type":"BreadcrumbList","@id":"https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://bytecodealliance.github.io/wamr.dev/","url":"https://bytecodealliance.github.io/wamr.dev/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://bytecodealliance.github.io/wamr.dev/blog/","url":"https://bytecodealliance.github.io/wamr.dev/blog/","name":"Blog"}},{"@type":"ListItem","position":3,"item":{"@id":"https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://bytecodealliance.github.io/#/schema/article/1","headline":"WAMR source debugging basic","description":"WAMR source debugging basic","isPartOf":{"@id":"https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/"},"mainEntityOfPage":{"@id":"https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/"},"datePublished":"2022-10-15T14:23:03CET","dateModified":"2022-10-15T14:23:03CET","author":{"@id":"https://bytecodealliance.github.io/#/schema/person/2"},"publisher":{"@id":"https://bytecodealliance.github.io/#/schema/organization/1"},"image":{"@id":"https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://bytecodealliance.github.io/#/schema/person/2","name":null,"sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/#/schema/image/2","url":"https://bytecodealliance.github.io/wamr.dev/wamr.png","contentUrl":"https://bytecodealliance.github.io/wamr.dev/wamr.png","caption":"WAMR source debugging basic"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=https://bytecodealliance.github.io/wamr.dev/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=https://bytecodealliance.github.io/wamr.dev/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=https://bytecodealliance.github.io/wamr.dev/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://bytecodealliance.github.io/wamr.dev/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://bytecodealliance.github.io/wamr.dev/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://bytecodealliance.github.io/wamr.dev/site.webmanifest></head><body class="blog single"><div class=sticky-top><style>.brand{position:relative;float:left;left:10px;z-index:1;padding:16px 0;text-decoration:none;color:#333}.brand:hover{filter:brightness(60%)}</style><div class=header-bar></div><header class="navbar navbar-expand-lg navbar-light doks-navbar"><div><a href=https://bytecodealliance.org/ class=brand><img src=https://bytecodealliance.github.io/wamr.dev//bytecode-alliance-logo.svg alt="Bytecode Alliance logo" width=164></a></div><nav class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=https://bytecodealliance.github.io/wamr.dev/ aria-label=WAMR>WAMR</a>
<button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>WAMR</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class=nav-item><a class="nav-link ps-0 py-1 active" href=/wamr.dev/blog/>Blog</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/wamr.dev/events/>Events</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/wamr.dev/resources/>Resources</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/bytecodealliance/wasm-micro-runtime><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul><hr class="text-black-50 my-4 d-lg-none"><button id=mode class="btn btn-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></div></div></nav></header></div><div class="wrap container-xxl" role=document><div class=content><article><div class="row justify-content-center"><div class="col-md-12 col-lg-10"><div class=blog-header><h1>WAMR source debugging basic</h1><p><small>Posted&nbsp;in&nbsp;<a class="stretched-link position-relative link-muted" href=https://bytecodealliance.github.io/wamr.dev/categories/debug/>debug</a>, <a class="stretched-link position-relative link-muted" href=https://bytecodealliance.github.io/wamr.dev/categories/tool/>tool</a>&nbsp;on&nbsp;October 15, 2022 by <a class="stretched-link position-relative" href=https://bytecodealliance.github.io/wamr.dev/contributors/xu-jun/>Xu Jun</a>&nbsp;&dash;&nbsp;<strong>10&nbsp;min read</strong></small><p></div></div><div class=col-md-13><div><figure class=figure><img class="figure-img img-fluid lazyload blur-up" data-sizes=auto src=https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover_hu95260241211d10ae948722c8fb26630a_77623_5ef86e298043d363ed480b76841fe2be.png data-srcset="https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover_hu95260241211d10ae948722c8fb26630a_77623_bd0bf3f09fe37389c69f2381b10c3cf3.png 900w,https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover_hu95260241211d10ae948722c8fb26630a_77623_038c97bfed0d1dafdb88359ee33b7446.png 800w,https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover_hu95260241211d10ae948722c8fb26630a_77623_51ee67ffe480d56a91a7f944d7f73fe0.png 700w,https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover_hu95260241211d10ae948722c8fb26630a_77623_57ce9bf3b79238fb1171659a44b37b56.png 600w,https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover_hu95260241211d10ae948722c8fb26630a_77623_17eadc48ac860a3aaec5d633288bb480.png 500w" width=1270 height=715 alt="WAMR source debugging basic"><noscript><img class="figure-img img-fluid" sizes=100vw srcset="https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover_hu95260241211d10ae948722c8fb26630a_77623_bd0bf3f09fe37389c69f2381b10c3cf3.png 900w,https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover_hu95260241211d10ae948722c8fb26630a_77623_038c97bfed0d1dafdb88359ee33b7446.png 800w,https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover_hu95260241211d10ae948722c8fb26630a_77623_51ee67ffe480d56a91a7f944d7f73fe0.png 700w,https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover_hu95260241211d10ae948722c8fb26630a_77623_57ce9bf3b79238fb1171659a44b37b56.png 600w,https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover_hu95260241211d10ae948722c8fb26630a_77623_17eadc48ac860a3aaec5d633288bb480.png 500w" src=https://bytecodealliance.github.io/wamr.dev/blog/wamr-source-debugging-basic/cover_hu95260241211d10ae948722c8fb26630a_77623_1270x715_fill_box_center_3.png width=1270 height=715 alt="WAMR source debugging basic"></noscript></figure></div></div><div class="col-md-12 col-lg-12"><center><small>Image from https://pspdfkit.com/blog/2020/the-state-of-debugging-in-webassembly/</small></center><div><h2>Table Of Contents</h2><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#setup>Setup</a></li><li><a href=#debugging-with-cli>Debugging with CLI</a></li><li><a href=#remote-debugging>Remote debugging</a></li><li><a href=#issue-with-evaluation-feature>Issue with evaluation feature</a><ul><li></li></ul></li><li><a href=#faq>FAQ</a></li></ul></nav></div><h2 id=background>Background <a href=#background class=anchor aria-hidden=true>#</a></h2><p>Debugging takes a great part in application development, debuggers provide the capability to inspect the internal state of the execution programs, which make it easier to let the program work properly. It is hard to imagine a programming world without debugger.</p><p>Luckily, WAMR has supported source debugging feature based on lldb, and now is ready for use.</p><blockquote><p>Thanks <a href=https://reviews.llvm.org/p/paolosev/>@Paolo Severini</a> from Microsoft for providing the patched lldb with WebAssembly support!</p><p>Thanks <a href=mailto://zhongmin.wzm@antgroup.com>@Wu Zhongmin</a> from Ant group for co-working on the source debugging feature!</p><p>üéâüéâüéâ</p></blockquote><h2 id=setup>Setup <a href=#setup class=anchor aria-hidden=true>#</a></h2><ol><li><p>Building WAMR with interpreter debugging enabled</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/bytecodealliance/wasm-micro-runtime.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> wasm-micro-runtime
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>WAMR_REPO</span><span class=o>=</span><span class=sb>`</span><span class=nb>pwd</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> product-mini/platforms/linux
</span></span><span class=line><span class=cl>mkdir build <span class=o>&amp;&amp;</span> <span class=nb>cd</span> build
</span></span><span class=line><span class=cl>cmake .. -DWAMR_BUILD_DEBUG_INTERP<span class=o>=</span><span class=m>1</span> -DWAMR_DISABLE_HW_BOUND_CHECK<span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>make
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>IWASM</span><span class=o>=</span><span class=sb>`</span><span class=nb>pwd</span><span class=sb>`</span>/iwasm
</span></span></code></pre></div><blockquote><p>We need to disable the <code>hardware boundary check</code> feature, otherwise the debugger will not be able to stop when an <code>out of bounds memory access</code> exception occurs.</p></blockquote><blockquote><p>We will use <code>$IWASM</code> to represent the generated iwasm binary in this step, and <code>$WAMR_REPO</code> represent the path to WAMR repo.</p></blockquote></li><li><p>Building lldb from source code</p><p>Official lldb and gdb doesn&rsquo;t support WebAssembly yet, we need to build the patched lldb manually from source code.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone --branch release/13.x --depth<span class=o>=</span><span class=m>1</span> https://github.com/llvm/llvm-project.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> llvm-project
</span></span><span class=line><span class=cl>git apply <span class=nv>$WAMR_REPO</span>/build-scripts/lldb-wasm.patch
</span></span><span class=line><span class=cl>mkdir build <span class=o>&amp;&amp;</span> <span class=nb>cd</span> build
</span></span><span class=line><span class=cl>cmake -DCMAKE_BUILD_TYPE:STRING<span class=o>=</span><span class=s2>&#34;Release&#34;</span> -DLLVM_ENABLE_PROJECTS<span class=o>=</span><span class=s2>&#34;clang;lldb&#34;</span> -DLLVM_TARGETS_TO_BUILD:STRING<span class=o>=</span><span class=s2>&#34;X86;WebAssembly&#34;</span> -DLLVM_ENABLE_LIBXML2:BOOL<span class=o>=</span>ON ../llvm
</span></span><span class=line><span class=cl>make -j <span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LLDB_BUILD_DIR</span><span class=o>=</span><span class=sb>`</span><span class=nb>pwd</span><span class=sb>`</span>
</span></span></code></pre></div><blockquote><p>We will use <code>$LLDB_BUILD_DIR</code> to represent the current build dir</p></blockquote><blockquote><p>Binary release for this patched lldb is planned and WIP, once finished, we can download the binaries directlyüòÄ.</p></blockquote></li></ol><h2 id=debugging-with-cli>Debugging with CLI <a href=#debugging-with-cli class=anchor aria-hidden=true>#</a></h2><p>Let&rsquo;s take a simple application written in C for example.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// main.c
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;stdio.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>double</span> <span class=n>global_variable</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>foo2</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;The global var is: %f</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>global_variable</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;The parameter is: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>foo2</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>local_variable</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>foo</span><span class=p>(</span><span class=n>local_variable</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>local_variable</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Enter loop with i = %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This simple code involves <code>local variable</code>, <code>global variable</code>, <code>function call</code> and <code>loop</code>, which can used to demonstrate most abilities of the debugger.</p><ol><li>Build this sample code with <code>wasi-sdk</code></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/opt/wasi-sdk/bin/clang -g main.c -o main.wasm -Wl,--export<span class=o>=</span>malloc,--export<span class=o>=</span>free
</span></span></code></pre></div><blockquote><p>Don&rsquo;t enable optimizations, and don&rsquo;t miss the <code>-g</code> option, otherwise the generated wasm file will not contain debug information.</p></blockquote><blockquote><p><code>-Wl,--export=malloc,--export=free</code> is required if you want to use the <code>evaluation expression</code> feature, please refer to <a href=#issue-with-evaluation-feature>issue with evaluation feature</a> for more details.</p></blockquote><ol start=2><li>launch the wasm app with debug feature enabled</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$IWASM</span> -g<span class=o>=</span>127.0.0.1:1234 main.wasm
</span></span><span class=line><span class=cl><span class=c1>#         ^^^^^^^^^ ^^^^</span>
</span></span><span class=line><span class=cl><span class=c1>#         bind addr:port</span>
</span></span></code></pre></div><ol start=3><li>open another terminal to launch lldb and attach to the debug server</li></ol><blockquote><p>Note: In the new terminal, the environment variable <code>LLDB_BUILD_DIR</code> may not exists, you may need to set it again manually.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># set LLDB_BUILD_DIR &lt;path to your lldb build dir&gt;</span>
</span></span><span class=line><span class=cl><span class=nv>$LLDB_BUILD_DIR</span>/bin/lldb
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> process connect -p wasm connect://127.0.0.1:1234
</span></span><span class=line><span class=cl>Process <span class=m>1</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;nobody&#39;, stop reason = signal SIGSTOP</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x40000000000001c6 main.wasm</span>
</span></span><span class=line><span class=cl>-&gt;  0x40000000000001c6: call   <span class=m>7</span>
</span></span><span class=line><span class=cl>    0x40000000000001cc: call   <span class=m>12</span>
</span></span><span class=line><span class=cl>    0x40000000000001d2: local.set <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span>
</span></span></code></pre></div><p>Everything ready!üçª Now we can start debugging the application.</p><ul><li><p><strong>Breakpoint/Continue</strong></p><p>Now let&rsquo;s create a breakpoint on a function and continue execution.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> b foo
</span></span><span class=line><span class=cl>Breakpoint 1: <span class=nv>where</span> <span class=o>=</span> main.wasm<span class=sb>`</span>foo + <span class=m>37</span> at main.c:14:38, <span class=nv>address</span> <span class=o>=</span> 0x4000000000000273
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> c
</span></span><span class=line><span class=cl>Process <span class=m>1</span> resuming
</span></span><span class=line><span class=cl>Process <span class=m>1</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;nobody&#39;, stop reason = breakpoint 1.1</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x4000000000000273 main.wasm`foo(x=0) at main.c:14:38</span>
</span></span><span class=line><span class=cl>       <span class=m>11</span>
</span></span><span class=line><span class=cl>       <span class=m>12</span>   int foo<span class=o>(</span>int x<span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=m>13</span>   <span class=o>{</span>
</span></span><span class=line><span class=cl>    -&gt; <span class=m>14</span>       printf<span class=o>(</span><span class=s2>&#34;The parameter is: %d\n&#34;</span>, x<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>       <span class=m>15</span>       foo2<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>       <span class=m>16</span>       <span class=k>return</span> x<span class=p>;</span>
</span></span><span class=line><span class=cl>       <span class=m>17</span>   <span class=o>}</span>
</span></span></code></pre></div></li><li><p><strong>Backtrace</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> bt
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;nobody&#39;, stop reason = breakpoint 1.1</span>
</span></span><span class=line><span class=cl>  * frame <span class=c1>#0: 0x4000000000000273 main.wasm`foo(x=0) at main.c:14:38</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#1: 0x400000000000030e main.wasm`__main_argc_argv(argc=1, argv=0x00011500) at main.c:24:5</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#2: 0x4000000000002772 main.wasm</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#3: 0x40000000000003a8 main.wasm</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#4: 0x40000000000001d2 main.wasm</span>
</span></span></code></pre></div><p>You can use <code>up</code>/<code>down</code> to navigate across the stack frames</p></li><li><p><strong>Display variables</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> up
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> fr v <span class=c1># dump variables from current stack frame</span>
</span></span><span class=line><span class=cl><span class=o>(</span>int<span class=o>)</span> <span class=nv>argc</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=o>(</span>char **<span class=o>)</span> <span class=nv>argv</span> <span class=o>=</span> 0x00011500
</span></span><span class=line><span class=cl><span class=o>(</span>int<span class=o>)</span> <span class=nv>local_variable</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>(</span>int<span class=o>)</span> <span class=nv>i</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> fr v global_variable <span class=c1># dump global_variable</span>
</span></span><span class=line><span class=cl><span class=o>(</span>double<span class=o>)</span> <span class=nv>global_variable</span> <span class=o>=</span> <span class=m>0</span>
</span></span></code></pre></div></li><li><p><strong>Evaluate expressions</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> e local_variable
</span></span><span class=line><span class=cl><span class=o>(</span>int<span class=o>)</span> <span class=nv>$0</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> p local_variable
</span></span><span class=line><span class=cl><span class=o>(</span>int<span class=o>)</span> <span class=nv>$1</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> e local_variable &gt; <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>(</span>bool<span class=o>)</span> <span class=nv>$2</span> <span class=o>=</span> <span class=nb>false</span>
</span></span></code></pre></div><blockquote><p>Note:</p><ol><li>If you encounter an error while using evaluation feature, please refer to <a href=#issue-with-evaluation-feature>issue with evaluation feature</a></li><li>in lldb <code>p</code> command actually use <code>evaluation</code>.</li></ol></blockquote></li><li><p><strong>Step/Finish</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> s
</span></span><span class=line><span class=cl>Process <span class=m>1</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;nobody&#39;, stop reason = step in</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x400000000000283c main.wasm</span>
</span></span><span class=line><span class=cl>-&gt;  0x400000000000283c: global.get <span class=m>0</span>
</span></span><span class=line><span class=cl>    0x4000000000002842: i32.const <span class=m>16</span>
</span></span><span class=line><span class=cl>    0x4000000000002844: i32.sub
</span></span><span class=line><span class=cl>    0x4000000000002845: local.tee <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> n
</span></span><span class=line><span class=cl>Process <span class=m>1</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;nobody&#39;, stop reason = instruction step over</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x4000000000002842 main.wasm</span>
</span></span><span class=line><span class=cl>-&gt;  0x4000000000002842: i32.const <span class=m>16</span>
</span></span><span class=line><span class=cl>    0x4000000000002844: i32.sub
</span></span><span class=line><span class=cl>    0x4000000000002845: local.tee <span class=m>2</span>
</span></span><span class=line><span class=cl>    0x4000000000002847: global.set <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> finish
</span></span><span class=line><span class=cl>Process <span class=m>1</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;nobody&#39;, stop reason = step out</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x4000000000000293 main.wasm`foo(x=0) at main.c:14:5</span>
</span></span><span class=line><span class=cl>   <span class=m>11</span>
</span></span><span class=line><span class=cl>   <span class=m>12</span>   int foo<span class=o>(</span>int x<span class=o>)</span>
</span></span><span class=line><span class=cl>   <span class=m>13</span>   <span class=o>{</span>
</span></span><span class=line><span class=cl>-&gt; <span class=m>14</span>       printf<span class=o>(</span><span class=s2>&#34;The parameter is: %d\n&#34;</span>, x<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=m>15</span>       foo2<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=m>16</span>       <span class=k>return</span> x<span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=m>17</span>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> finish
</span></span><span class=line><span class=cl>Process <span class=m>1</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;nobody&#39;, stop reason = step out</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x400000000000030e main.wasm`__main_argc_argv(argc=1, argv=0x00011500) at main.c:24:5</span>
</span></span><span class=line><span class=cl>   <span class=m>21</span>       int <span class=nv>local_variable</span> <span class=o>=</span> 0<span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=m>22</span>       int <span class=nv>i</span> <span class=o>=</span> 0<span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=m>23</span>
</span></span><span class=line><span class=cl>-&gt; <span class=m>24</span>       foo<span class=o>(</span>local_variable<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=m>25</span>
</span></span><span class=line><span class=cl>   <span class=m>26</span>       <span class=k>for</span> <span class=o>(</span><span class=nv>i</span> <span class=o>=</span> 0<span class=p>;</span> i &lt; local_variable<span class=p>;</span> i++<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=m>27</span>           printf<span class=o>(</span><span class=s2>&#34;Enter loop with i = %d\n&#34;</span>, i<span class=o>)</span><span class=p>;</span>
</span></span></code></pre></div></li><li><p><strong>Modify the value</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> e <span class=nv>local_variable</span> <span class=o>=</span> <span class=m>5</span>
</span></span><span class=line><span class=cl><span class=o>(</span>int<span class=o>)</span> <span class=nv>$3</span> <span class=o>=</span> <span class=m>5</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> c
</span></span><span class=line><span class=cl>Process <span class=m>1</span> resuming
</span></span><span class=line><span class=cl>Process <span class=m>1</span> exited with <span class=nv>status</span> <span class=o>=</span> <span class=m>0</span> <span class=o>(</span>0x00000000<span class=o>)</span>
</span></span></code></pre></div><p>Since we modify the value of <code>local_variable</code> to 5, we will enter the loop 5 times, and then the program exit.</p></li><li><p><strong>Exception</strong></p><p>When debugging a native executable, the debugger will stopped once there is a segment fault, and the developer can then see the callstack to the bug code.</p><p>However, in WebAssembly the memory is protected by sandbox, even the application access some invalid spaces, the runtime will raise an exception rather than segment fault.</p><p>In WAMR, we extend the debug engine to pause on exception, so the developer can inspect the latest state of the program and know which line in source code causes this problem.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>local_variable</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=p>)(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>local_variable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>foo</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>local_variable</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Enter loop with i = %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This time we add a line to the original <code>main.c</code>. <code>(int *)(-1)</code> is a very large space and certainly go beyond the linear memory boundary, this will trigger an <code>out of bound memory access</code> exception.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/opt/wasi-sdk/bin/clang -g main.c -o main.wasm
</span></span><span class=line><span class=cl><span class=nv>$IWASM</span> main.wasm
</span></span><span class=line><span class=cl>Exception: out of bounds memory access
</span></span></code></pre></div><p>Launch it with debug feature, and continue execution</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$IWASM</span> -g<span class=o>=</span>127.0.0.1:1234 main.wasm
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$LLDB_BUILD_DIR</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> process connect -p wasm connect://127.0.0.1:1234
</span></span><span class=line><span class=cl>Process <span class=m>1</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;nobody&#39;, stop reason = signal SIGSTOP</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x40000000000001c6 main.wasm</span>
</span></span><span class=line><span class=cl>-&gt;  0x40000000000001c6: call   <span class=m>7</span>
</span></span><span class=line><span class=cl>    0x40000000000001cc: call   <span class=m>12</span>
</span></span><span class=line><span class=cl>    0x40000000000001d2: local.set <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> c
</span></span><span class=line><span class=cl>Process <span class=m>1</span> resuming
</span></span><span class=line><span class=cl>Process <span class=m>1</span> stopped
</span></span><span class=line><span class=cl>* thread <span class=c1>#1, name = &#39;nobody&#39;, stop reason = Exception: out of bounds memory access</span>
</span></span><span class=line><span class=cl>    frame <span class=c1>#0: 0x4000000000000290 main.wasm`foo(x=0) at main.c:14:18</span>
</span></span><span class=line><span class=cl>   <span class=m>11</span>
</span></span><span class=line><span class=cl>   <span class=m>12</span>   int foo<span class=o>(</span>int x<span class=o>)</span>
</span></span><span class=line><span class=cl>   <span class=m>13</span>   <span class=o>{</span>
</span></span><span class=line><span class=cl>-&gt; <span class=m>14</span>       *<span class=o>(</span>int *<span class=o>)(</span>-1<span class=o>)</span> <span class=o>=</span> 100<span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=m>15</span>       printf<span class=o>(</span><span class=s2>&#34;The parameter is: %d\n&#34;</span>, x<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=m>16</span>       foo2<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=m>17</span>       <span class=k>return</span> x<span class=p>;</span>
</span></span></code></pre></div><p>Then we can see the call stack and inspect stack frames. If the exception occurs in a large project, this feature will save a lot of time to find the root cause.</p></li></ul><p>Now we have tried some common used features of debugger, but it&rsquo;s finished by command line. <strong>Is there a more efficient way?</strong></p><p><strong>Of course!</strong> See: <a href=https://bytecodealliance.github.io/wamr.dev/blog/debugging-wasm-with-vscode/ title="Debugging wasm with VSCode">Debugging wasm with VSCode</a>!</p><h2 id=remote-debugging>Remote debugging <a href=#remote-debugging class=anchor aria-hidden=true>#</a></h2><p>When debugging feature enabled, WAMR will host a gdb server and wait for a debugger connection, it is already a remote debugging architecture.</p><p>If you want to run <code>runtime</code> and <code>debugger</code> in different machine, then you should take care about these 3 things:</p><ol><li><p>Bind address <code>0.0.0.0</code> rather than <code>127.0.0.1</code></p></li><li><p>There should be a copy of source code on the debugger machine, and a source-map is correctly set after launching LLDB, otherwise the debugger will not be able to find the source lines</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> settings <span class=nb>set</span> -- target.source-map &lt;src_dir&gt; &lt;dest_dir&gt;
</span></span></code></pre></div></li><li><p>WAMR uses Unix signal numbers, if your debugger runs on non-Linux platforms (e.g. Windows), remember to set the remote platform before connecting</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> platform <span class=k>select</span> remote-linux
</span></span><span class=line><span class=cl><span class=o>(</span>lldb<span class=o>)</span> process connect -p wasm connect://xxx.xxx.xxx.xxx:1234
</span></span></code></pre></div></li></ol><h2 id=issue-with-evaluation-feature>Issue with evaluation feature <a href=#issue-with-evaluation-feature class=anchor aria-hidden=true>#</a></h2><p>lldb will require a large buffer inside linear memory when evaluating an expression, we call it <code>Evaluation buffer</code> here.</p><p>The problem happens when the application is built with <code>wasi</code> mode and exported the <code>malloc</code> function:</p><ul><li>the interpreter stops at somewhere because of breakpoint or stepping, lldb become interactive</li><li>user enter a command to evaluate an expression</li><li>lldb send a allocate memory request to runtime (debug server)</li><li>runtime will invoke the <code>malloc</code> function in wasm application (which means we need to re-enter the interpreter), but at this moment the interpreter is at stop state and waiting debugger&rsquo;s signal to continue execution, which cause the program to hang.</li></ul><div style=text-align:center><img src=debugger_hang.excalidraw.png></div><p>To solve this problem, we try to reserve enough memory space in linear memory during loading, and if the runtime failed to allocate this buffer during loading, a warning will be displayed:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>09:43:45:506 - 7FA23A5EFB80<span class=o>]</span>: warning: allocate <span class=m>544768</span> bytes memory failed
</span></span><span class=line><span class=cl><span class=o>[</span>09:43:45:540 - 7FA23A5EFB80<span class=o>]</span>: WASM Debug Engine warning: failed to allocate linear memory <span class=k>for</span> execution.
</span></span><span class=line><span class=cl>Will not be able to evaluate expressions during debugging
</span></span><span class=line><span class=cl><span class=o>[</span>09:43:45:733 - 7FA23A96F700<span class=o>]</span>: control thread of debug object 0x55fb399d3d20 start
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>09:43:45:841 - 7FA23A96F700<span class=o>]</span>: Debug server listening on 127.0.0.1:1234
</span></span></code></pre></div><p>and any evaluation command in debugger session will not work and get such kind of error:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>error: Couldn<span class=s1>&#39;t allocate space for materialized struct: Couldn&#39;</span>t malloc: address space is full
</span></span><span class=line><span class=cl>error: errored out in DoExecute, couldn<span class=err>&#39;</span>t PrepareToExecuteJITExpression
</span></span></code></pre></div><h4 id=how-to-fix-the-warning>How to fix the warning? <a href=#how-to-fix-the-warning class=anchor aria-hidden=true>#</a></h4><p>If you don&rsquo;t need the evaluation feature, then just ignore the warning and it will not influence other features, otherwise the solution depends on the libc mode</p><ul><li><p>If your app is built with <code>libc-wasi</code></p><ol><li><p>If your wasm module doesn&rsquo;t export <code>malloc</code> and <code>free</code>, try to rebuild your wasm module with <code>-Wl,--export=malloc,--export=free</code> option, or refer to the method for <code>libc-builtin</code> mode</p></li><li><p>Otherwise, seems you set the <code>maximum memory</code> flag during compiling and the given value is not enough, try to rebuild with a larger value or remain maximum memory unspecified.</p></li></ol></li><li><p>If your app is built with <code>libc-builtin</code></p><p>In this mode, all the dynamic memory goes into WAMR&rsquo;s <code>app_heap</code>, the design of WAMR&rsquo;s linear memory will not be covered by this blog post, please refer to our <a href=https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/memory_tune.md>memory_tune</a> document for more details.</p><p>The problem is <code>app_heap</code> is not enough, specify a larger value can solve this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$IWASM</span> -g<span class=o>=</span>127.0.0.1:1234 --heap-size<span class=o>=</span><span class=m>655360</span> main.wasm
</span></span></code></pre></div></li></ul><blockquote><p>This size should be no less than <code>532 KB</code> (<code>544768 bytes</code>)</p></blockquote><h2 id=faq>FAQ <a href=#faq class=anchor aria-hidden=true>#</a></h2><ul><li><p><strong>Does WAMR&rsquo;s source debugging support <code>watchpoint</code>?</strong></p><p>Currently not, but this feature is planned and on the priority list.</p></li><li><p><strong>Which platforms are supported</strong></p><p>Currently the source debugging feature supports Linux, Windows, MacOS, Android, other platforms may work but not well tested.</p></li><li><p><strong>Does this support debugging <code>AssemblyScript</code>?</strong></p><p>Unfortunately, No. We use <code>dwarf</code> based debugging solution while AssemblyScript currently uses source map.</p></li><li><p><strong>Does this feature support embedded devices?</strong></p><p>Source debugger feature mainly depends on socket interface.</p><p>If your platform support socket then it should be OK.</p><p>But for devices only have <code>USART</code> interface, currently we don&rsquo;t support that. This requires a usart based communication channel, it should not be very complex to implement, but it&rsquo;s not on our priority list.</p></li><li><p><strong>Does this work with AOT/JIT</strong></p><p>Debugging AoT/JIT module is totally a different solution which is not covered by this blog.</p><p>Currently WAMR has a highly experimental support for AOT/JIT debug, please refer to the <a href=https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/source_debugging.md#debugging-with-aot>document</a> for more details.</p></li><li><p><strong>Does this work with <code>multi-thread wasm application</code>?</strong></p><p>No, currently the debugger can&rsquo;t distinguish stack frame from different thread, if you attempt to debug a multi-thread wasm app, there may be unexpected behavior.</p></li><li><p><strong>Does this work with <code>multiple native thread and each thread runs a wasm app</code>?</strong></p><p>Yes, each app will have its own gdb server, they are totally independent.</p></li></ul><div class=mt-4><a class="btn btn-light" href=https://bytecodealliance.github.io/wamr.dev/tags/debug/ role=button>debug</a></div><div class=card><div class=card-header>Interested in WAMR?</div><div class=card-body><div class=row><a style=margin-top:10px href=https://bytecodealliance.zulipchat.com/#narrow/stream/290350-wamr><img src=https://img.shields.io/badge/zulip-join_chat-brightgreen.svg></a>
<a style=margin-top:10px href=https://github.com/bytecodealliance/wasm-micro-runtime><img alt="GitHub Repo stars" src="https://img.shields.io/github/stars/bytecodealliance/wasm-micro-runtime?label=WAMR%C2%B7Stars&style=social"></a>
<a style=margin-top:10px href=https://github.com/bytecodealliance/wasm-micro-runtime/fork><img alt="GitHub forks" src="https://img.shields.io/github/forks/bytecodealliance/wasm-micro-runtime?label=WAMR%C2%B7Forks&style=social"></a></div></div></div></div></div></article><div class=related-posts><div class="row justify-content-center"><div class=col><h2 class=section-title>Related posts</h2></div></div><div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-lg-5"><div class=col><div class=card><img class="card-img-top img-fluid lazyload blur-up" src=https://bytecodealliance.github.io/wamr.dev/images/webassembly-pic_hud1b10bf37d0f451b4f749d91f3480ef1_10720_ce4a0bdcfbeed75890dfeec06c858a7a.webp data-src=https://bytecodealliance.github.io/wamr.dev/images/webassembly-pic_hud1b10bf37d0f451b4f749d91f3480ef1_10720_1270x620_resize_q75_h2_box_3.webp width=1270 height=620 alt="Debugging wasm with VSCode"><div class=card-body><article><h2 class=h3><a class="stretched-link text-body" href=/wamr.dev/blog/debugging-wasm-with-vscode/>Debugging wasm with VSCode</a></h2><p>Debugging wasm inside VSCode based on WAMR's source debugging feature</p><p><small>Posted&nbsp;in&nbsp;<a class="stretched-link position-relative link-muted" href=https://bytecodealliance.github.io/wamr.dev/categories/debug/>debug</a>, <a class="stretched-link position-relative link-muted" href=https://bytecodealliance.github.io/wamr.dev/categories/tool/>tool</a>&nbsp;on&nbsp;October 26, 2022 by <a class="stretched-link position-relative" href=https://bytecodealliance.github.io/wamr.dev/contributors/xu-jun/>Xu Jun</a>&nbsp;&dash;&nbsp;<strong>1&nbsp;min read</strong></small><p></article></div></div></div></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://gohugo.io/>Hugo</a>, and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=/wamr.dev/js/bootstrap.min.650aeec64c81d69d4c0850fc73c93da3f0330cec0a27772feed7f90f60baa5f47f1c45687d71914bdafd1c4e860d40f6dc08ede27a2f08431ff929c9a2d24621.js integrity="sha512-ZQruxkyB1p1MCFD8c8k9o/AzDOwKJ3cv7tf5D2C6pfR/HEVofXGRS9r9HE6GDUD23Ajt4novCEMf+SnJotJGIQ==" crossorigin=anonymous defer></script>
<script src=/wamr.dev/js/highlight.min.6efdec8375dd620e0a357860aafeb5c97c7b51f33c9c594d57fa7f76cf22d2a6e0e39f8127dfed74d737512bfdb23f641827578b3fe09da15442a003c878a033.js integrity="sha512-bv3sg3XdYg4KNXhgqv61yXx7UfM8nFlNV/p/ds8i0qbg45+BJ9/tdNc3USv9sj9kGCdXiz/gnaFUQqADyHigMw==" crossorigin=anonymous defer></script>
<script src=/wamr.dev/main.min.cb2e2ebbf2e4002f3117addc33582923b2b3ae5265c22944cd117ebec7abe61c170417c4506d7a0f8f0fc9053dfdf441421d53601ac467042ff3d06ec0ba07fa.js integrity="sha512-yy4uu/LkAC8xF63cM1gpI7KzrlJlwilEzRF+vser5hwXBBfEUG16D48PyQU9/fRBQh1TYBrEZwQv89BuwLoH+g==" crossorigin=anonymous defer></script>
<script src=https://bytecodealliance.github.io/wamr.dev/index.min.4ae26272486ea46c5bb0bed7a0b434a91b05e8182cfb839a405dd4e647b05ce5d76d401a5103d822d3b1589fc56335cd372b712d97085b8d89aebf244b1b5501.js integrity="sha512-SuJickhupGxbsL7XoLQ0qRsF6Bgs+4OaQF3U5kewXOXXbUAaUQPYItOxWJ/FYzXNNytxLZcIW42Jrr8kSxtVAQ==" crossorigin=anonymous defer></script></body></html>